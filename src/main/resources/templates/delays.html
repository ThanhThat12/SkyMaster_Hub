<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Delays Tracker</title>
    <style th:replace="fragments/navbar :: navbar-css"></style>
    <link rel="stylesheet" th:href="@{/delays.css}">
</head>
<body>
    <nav th:replace="fragments/navbar :: navbar"></nav>
    <div class="container">
        <h1>Flight Delays Trackerdsadsadas</h1>

        <!-- Success/Error Messages -->
        <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-error" th:text="${errorMessage}"></div>

        <!-- Info Banner: Show count of stored delays -->
        <div th:if="${storedCount != null and storedCount > 0}" 
             style="background: #EBF8FF; border: 1px solid #90CDF4; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                
                <div>
                    <strong style="color: #2C5282;">Database has <span th:text="${storedCount}">0</span> stored delays</strong>
                    <p style="margin: 5px 0 0 0; color: #4A5568; font-size: 14px;">
                        These are delays previously fetched from the API
                    </p>
                </div>
            </div>
        </div>

      
        <div class="section" th:if="${cacheInfo}">
            <h2> Cache Status </h2>
            
            <!-- Cache Statistics -->
            <div class="cache-stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Cache Size</div>
                    <div class="stat-value" th:text="${cacheInfo.size} + ' / ' + ${cacheInfo.capacity}">0 / 3</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Total Hits</div>
                    <div class="stat-value" th:text="${cacheInfo.hitCount}">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Total Misses</div>
                    <div class="stat-value" th:text="${cacheInfo.missCount}">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Evictions</div>
                    <div class="stat-value" th:text="${cacheInfo.evictionCount}">0</div>
                </div>
            </div>

         
            <div>
                <strong>Capacity Utilization:</strong>
                <div class="progress-bar">
                    <div class="progress-fill" th:style="'width: ' + ${cacheInfo.utilizationPercent} + '%'"></div>
                </div>
                <p style="text-align: right; margin-top: 5px; font-size: 12px; color: #718096;">
                    <span th:text="${#numbers.formatDecimal(cacheInfo.utilizationPercent, 1, 2)}">0</span>% used
                </p>
            </div>

            <!-- Cache Entries List -->
            <div style="margin-top: 25px;">
                <h3 style="color: #2d3748; margin-bottom: 15px; font-size: 18px;">
                     Cached Entries (<span th:text="${#lists.size(cacheInfo.entries)}">0</span>)
                </h3>
                
                <div class="empty-cache" th:if="${#lists.isEmpty(cacheInfo.entries)}">
                    <div style="font-size: 48px;">üì≠</div>
                    <p>Cache tr·ªëng. H√£y fetch data ƒë·ªÉ th·∫•y cache ho·∫°t ƒë·ªông!</p>
                </div>

                <div class="cache-entries-list" th:if="${not #lists.isEmpty(cacheInfo.entries)}">
                    <div class="cache-entry" th:each="entry : ${cacheInfo.entries}">
                        <div>
                            <div class="cache-key" th:text="${entry.key}">cache-key</div>
                        </div>
                        <div class="cache-meta">
                            <span>
                                 <strong th:text="${entry.flightCount}">0</strong> flights
                            </span>
                            <span>
                                 <strong th:text="${entry.hitCount}">0</strong> times
                            </span>
                            <span>
                                 <strong th:text="${#numbers.formatDecimal(entry.sizeKB, 1, 1)}">0</strong> KB
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fetch New Delays Form -->
        <div class="section">
            <h2> Fetch Delayed Flights from API</h2>
            <form action="/delays/fetch" method="post">
                <div class="form-row">
                    <div class="form-group">
                        <label for="type">Type:</label>
                        <select id="type" name="type" required>
                            <option value="arrivals">Arrivals</option>
                            <option value="departures">Departures</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="iataCode">Airport Code (IATA):</label>
                        <input type="text" id="iataCode" name="iataCode" 
                               placeholder="JFK, LAX, SGN" 
                               maxlength="3" required>
                    </div>
                    <div class="form-group">
                        <label for="minDelay">Min Delay (minutes):</label>
                        <input type="number" id="minDelay" name="minDelay" 
                               value="30" min="0" max="500" required>
                    </div>
                </div>
                <button type="submit"> Fetch from API</button>
            </form>
        </div>

        <!-- Search Delays Form -->
        <div class="section">
            <h2> Search Delayed Flights</h2>
            <form action="/delays/search" method="get">
                <div class="form-row">
                    <div class="form-group">
                        <label for="searchIataCode">Arrival Airport:</label>
                        <input type="text" id="searchIataCode" name="iataCode" 
                               placeholder="JFK" maxlength="3">
                    </div>
                    <div class="form-group">
                        <label for="searchAirline">Airline Code:</label>
                        <input type="text" id="searchAirline" name="airline" 
                               placeholder="AA, DL, UA" maxlength="3">
                    </div>
                    <div class="form-group">
                        <label for="searchDepIata">Departure Airport:</label>
                        <input type="text" id="searchDepIata" name="depIata" 
                               placeholder="LAX" maxlength="3">
                    </div>
                </div>
                <button type="submit">üîç Search</button>
            </form>
        </div>

        <!-- Show All Stored Delays Button -->
        <div class="section" th:if="${storedCount != null and storedCount > 0 and !storedDelaysShown}">
            <div style="text-align: center; padding: 20px; background: #F7FAFC; border-radius: 8px;">
                <p style="margin-bottom: 15px; color: #4A5568;">
                    Want to see all delays previously fetched from the API?
                </p>
                <a href="/delays/stored" style="display: inline-block; background: #4299E1; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 500;">
                     Show All Stored Delays (<span th:text="${storedCount}">0</span>)
                </a>
            </div>
        </div>

        <!-- Delays Table -->
        <div class="section">
            <h2>
                Delayed Flights 
                <span th:if="${showResults}" th:text="'(' + ${#lists.size(delays)} + ')'">(0)</span>
            </h2>
            
            <!-- Empty State: Initial page load (no search/fetch yet) -->
            <div class="empty-state" th:if="${!showResults and #lists.isEmpty(delays)}">
                <div class="empty-state-icon">üõ´</div>
                <h3>No Flights Displayed</h3>
                <p style="margin-bottom: 15px;">Use the forms above to:</p>
                <ul style="text-align: left; display: inline-block; color: #718096;">
                    <li><strong>Fetch from API</strong> - Get latest delayed flights</li>
                    <li><strong>Search</strong> - Filter stored delays</li>
                    <li><strong>Show Stored</strong> - View all previously fetched delays</li>
                </ul>
            </div>

            <!-- Empty State: After search with no results -->
            <div class="empty-state" th:if="${showResults and #lists.isEmpty(delays)}">
                <div class="empty-state-icon">üîç</div>
                <h3>No Results Found</h3>
                <p th:if="${searchPerformed}">No delays match your search criteria.</p>
                <p th:if="${storedDelaysShown}">No delays have been stored yet. Try fetching from the API first.</p>
                <p th:unless="${searchPerformed or storedDelaysShown}">The API returned no delayed flights for this query.</p>
            </div>

            <!-- Results Table -->
            <table th:if="${showResults and not #lists.isEmpty(delays)}">
                <thead>
                    <tr>
                        <th>Flight</th>
                        <th>Airline</th>
                        <th>Departure</th>
                        <th>Dep Time</th>
                        <th>Arrival</th>
                        <th>Arr Time</th>
                        <th>Delay (min)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="delay : ${delays}">
                        <td th:text="${delay.flightIata}">-</td>
                        <td th:text="${delay.airlineIata}">-</td>
                        <td th:text="${delay.depIata}">-</td>
                        <td th:text="${delay.depTime}">-</td>
                        <td th:text="${delay.arrIata}">-</td>
                        <td th:text="${delay.arrTime}">-</td>
                        <td>
                            <strong style="color: #e53e3e;" th:text="${delay.delayMinutes}">0</strong>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>
<link rel="stylesheet" href="/css/delays.css">

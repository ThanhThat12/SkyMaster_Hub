<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Flight Tracker</title>
    <style th:replace="fragments/navbar :: navbar-css"></style>
    <link rel="stylesheet" th:href="@{/realtime.css}">
</head>
<body>
    <nav th:replace="fragments/navbar :: navbar"></nav>
    <div class="container">
        <h1> Real-time Flight Tracker</h1>

        <!-- Success/Error Messages -->
        <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-error" th:text="${errorMessage}"></div>

        <!-- Cache Status Section -->
        <div class="section" th:if="${cacheInfo}">
            <h2> Cache Status</h2>
            
            <!-- Cache Statistics -->
            <div class="cache-stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Cache Size</div>
                    <div class="stat-value" th:text="${cacheInfo.size} + ' / ' + ${cacheInfo.capacity}">0 / 100</div>
                </div>
                <!-- <div class="stat-box">
                    <div class="stat-label">Hit Rate</div>
                    <div class="stat-value" th:text="${cacheInfo.hitRate}">0%</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Total Hits</div>
                    <div class="stat-value" th:text="${cacheInfo.hitCount}">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Total Misses</div>
                    <div class="stat-value" th:text="${cacheInfo.missCount}">0</div>
                </div> -->
                <div class="stat-box">
                    <div class="stat-label">Evictions</div>
                    <div class="stat-value" th:text="${cacheInfo.evictionCount}">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">TTL</div>
                    <div class="stat-value" th:text="${cacheInfo.ttl}">2 minutes</div>
                </div>
            </div>

            <!-- Capacity Utilization -->
            <div>
                <strong>Capacity Utilization:</strong>
                <div class="progress-bar">
                    <div class="progress-fill" th:style="'width: ' + ${cacheInfo.utilizationPercent} + '%'"></div>
                </div>
                <p style="text-align: right; margin-top: 5px; font-size: 12px; color: #718096;">
                    <span th:text="${#numbers.formatDecimal(cacheInfo.utilizationPercent, 1, 2)}">0</span>% used
                </p>
            </div>

            <!-- Cache Entries List -->
            <div style="margin-top: 25px;">
                <h3 style="color: #2d3748; margin-bottom: 15px; font-size: 18px;">
                     Cached Entries (<span th:text="${#lists.size(cacheInfo.entries)}">0</span>)
                </h3>
                
                <div class="empty-cache" th:if="${#lists.isEmpty(cacheInfo.entries)}">
                    
                    <p>Cache empty</p>
                </div>

                <div class="cache-entries-list" th:if="${not #lists.isEmpty(cacheInfo.entries)}">
                    <div class="cache-entry" th:each="entry : ${cacheInfo.entries}">
                        <div>
                            <div class="cache-key" th:text="${entry.key}">cache-key</div>
                        </div>
                        <div class="cache-meta">
                            <span>
                                 <strong th:text="${entry.flightCount}">0</strong> flights
                            </span>
                            <span>
                                 <strong th:text="${entry.hitCount}">0</strong> hits
                            </span>
                            <span>
                                 <strong th:text="${#numbers.formatDecimal(entry.sizeKB, 1, 1)}">0</strong> KB
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Flights -->
<form action="/realtime-flights/fetch" method="post">
    <div class="form-row">
        <div class="form-group">
            <label for="depIata">Departure Airport (IATA):</label>
            <input type="text"
                   id="depIata"
                   name="depIata"
                   placeholder="DAD, HAN, SGN"
                   maxlength="3"
                   required>
        </div>
    </div>
    <button type="submit">Search Flights</button>
</form>

<!-- Clear Cache (FORM RIÊNG) -->
<form action="/realtime-flights/clear-cache"
      method="post"
      style="margin-top: 10px;">
    <button type="submit"
            style="background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);">
        Clear Cache
    </button>
</form>

        <!-- Real-time Flights Table -->
        <div class="section">
            <h2> Active Flights (<span th:text="${#lists.size(flights)}">0</span>)</h2>
            
            <div class="empty-state" th:if="${#lists.isEmpty(flights)}">
                <div class="empty-state-icon"></div>
                <h3 th:if="${not searchPerformed}">Enter Airport Code</h3>
                <h3 th:if="${searchPerformed}">No Flights Found</h3>
                <p th:if="${not searchPerformed}">Enter a departure airport code (e.g., DAD, HAN, SGN) to track real-time flights.</p>
                <p th:if="${searchPerformed}">No active flights found departing from this airport.</p>
            </div>

            <table th:if="${not #lists.isEmpty(flights)}">
                <thead>
                    <tr>
                        <th>Flight</th>
                        <th>Airline</th>
                        <th>Aircraft</th>
                        <th>Departure</th>
                        <th>Arrival</th>
                        <th>Altitude</th>
                        <th>Speed</th>
                        <th>Direction</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="flight : ${flights}">
                        <td>
                            <strong th:text="${flight.flightIata}">-</strong>
                        </td>
                        <td th:text="${flight.airlineIata}">-</td>
                        <td th:text="${flight.aircraftIcao}">-</td>
                        <td th:text="${flight.depIata}">-</td>
                        <td th:text="${flight.arrIata}">-</td>
                        <td th:text="${flight.alt != null ? flight.alt + ' ft' : '-'}">-</td>
                        <td th:text="${flight.speed != null ? flight.speed + ' kt' : '-'}">-</td>
                        <td th:text="${flight.dir != null ? #numbers.formatDecimal(flight.dir, 1, 1) + '°' : '-'}">-</td>
                        <td>
                           <span th:text="${flight.status}">unknown</span>

                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Auto uppercase IATA code
        document.getElementById('depIata').addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    </script>
</body>
</html>
